---
title: "Métodos Cuantitativos en Ecología - MCE5"
subtitle: "EXAMEN FINAL - 2022II"
author: 'ANDY AVILÉS LIZETH FÁTIMA'"
date: "`r Sys.Date()`
output:
  html_document:
    toc: yes
    toc_depth: 4
    highlight: espresso
    theme: paper
    toc_float:
      collapsed: no
      smooth_scroll: yes
---

```{r echo = FALSE, results = 'asis'}
image = "https://www.ikiam.edu.ec/wp-content/uploads/2021/12/logo-ikiam-1.png"
cat(paste0('<center><img src="', image,  '"></center>')) 
```

Los contenidos de esta evaluación corresponden a los temas:

-   GLM y GAM

-   Introducción a estadística Bayesiana

-   Series de tiempo

-   Análisis espacial


Ustedes estan utilizando un archivo tipo R Markdown (`.Rmd`). Las instruciones son **[1 PUNTO]**:

-   Bifurquen el repositorio en GitHub y clonen en su computador usando un proyecto con control de la versión de RStudio.

-   Arriba, donde dice "author", deben llenar sus nombres.

-   **Todo resultado debe ir con su explicación y/o discusión, caso contrario no se calificará.**

-   **NO IMPRIMA los datos o tablas completas**, reporte únicamente figuras o tablas resumen. Si tiene varias figuras use la función `ggarrange` de la librería `ggpubr`.  

-   Al final de este examen deben utilizar el comando "Knit" para generar un archivo HTML.

-   **Cada pregunta debe tener al menos un cntrol de la versión**.

-   Su entrega consiste en colocar el **enlace de GitHub** en la actividad "ExamenFinal".

## **PREGUNTA 1: GLM, GAM y Regresión Bayesiana [3 PUNTOS]**

En el archivo `"glm.xlsx"` tiene tres datos: 

- aedes: insecticidas utilizados para controlar el número de mosquitos en un experimento. Cada vez que se repite la aplicación del insecticida parece disminuir la cantidad de zancudos vivos.

- leishmania: en una infección con leishmania cuando se analiza el tejido qué sucede con la concentración de algunas células y si están o no afectadas. 

- disease: cómo la edad afecta a diferentes características dicotómicas. 

Realice los siguientes análisis: 

- aedes: GLM Poisson

- disease: GLMs binomiales

- leishmania: glm bayesiano

Realizar los siguientes análisis y respectivas interpretaciones: 

1. Análisis exploratorio.

2. Planteamiento de hipótesis.

3. Análisis de regresión 

4. Planteamiento del modelo. 

5. Validez del modelo.

```{r}
##Exploración de datos de aedes
library(tidyverse)
library(readr)
library(dplyr)
aedes <- read_excel("~/aedes.xlsx")
str(aedes)
summary(aedes)

```
En aedes tenemos mediana de 523.5, la media de 865.4, el tercer cuartil de 1217.8 dando ententer que tiene el valor más alto.
```{r}
plot(aedes$repetition, aedes$aedes)
```
Planteamientos de HIPOTESIS
HO: Los insecticidad que estan descritas aumentan la cantidad de mosquitos  no afectado a las células.
HA: Los insecticidad que estan descritas disminuyen la cantidad de mosquitos afectado a las células.

```{r}
##Exploración de datos
library(tidyverse)
library(readr)
library(dplyr)
Leishmania <- read_excel("~/Leishmania.xlsx")
str(Leishmania)
summary(Leishmania)
```
En la exploración de datos no smuestra datos de otras enfer..percent_blast donde la mediana es 0.9500    percent_affect de la mediana es de 0.6500  percent_leuco=0.6300   periferia_leuc= 0.900 periferia_blast= 0.5200
lo que nos da a entender que contamos on un valor alto en percent blast. Igualmente la temperatura varía de de 0.9 a 1.-.


```{r}
##Exploración de datos
library(tidyverse)
library(readr)
library(dplyr)
disease <- read_excel("~/disease.xlsx")
str(disease)
summary(disease)
```
Tenemos datos nativo , datos genero, el tramiento y lo años, conmparando con estos datos vemos que gender, treatment, recover cuenta con un dato de 1000, el cuartil 1 de el resto de datos es de o menos el de año que cuneta con 9.5



## **PREGUNTA 2: Series de tiempo [3 PUNTOS]**

En el archivo `"ts.xlsx"` tiene tres datos: 

- quakes: cantidad de eventos de terremotos por cada año.

- hepatitis: casos de hepatitis por mes entre 2010 y 2017 (acomodar la tabla si es necesario) 

- wildfire: cantidad de eventos de incendios forestales por mes entre 2003 y 2017.



Realizar los siguientes análisis y respectivas interpretaciones: 

1. Análisis exploratorio: autocorrelación y descomposición, análisis estacional.

2. ARIMA, SARIMA, ETS, NNAR

3. Validez de los modelos.

4. Predicción a 20 años o a 24 meses según corresponda. 



## **PREGUNTA 3: Análisis espacial de especies [3 PUNTOS]**

Seleccione una especie de planta y una especie de animal; asimismo, dos tipos de modelos de predicción (glm, gam, rf, ann, otro): 

- Mosquito: *Aedes aegypti*

- Puma: *Puma concolor*

- Coati: *Nasua nasua*

- Tapir: *Tapirus terrestris*

- Jaguar: *Panthera onca*

- Palma de cera: *Ceroxylon quindiuense*

- Ceibo: *Ceiba pentandra* 

- Pasiflora: *Passiflora edulis*

- Chirimoya: *Anona cherimola*

Luego realice un análisis espacial de distribución de la especie en Ecuador continental en base a los datos de presencia del GBIF (use rgbif para descargar la data). Explique el resultado y compare la diferencia entre la salida de los dos modelos. En qué regiones los modelos difieren más en la predicción?   

```{r}
#Distribución espacial de la  especie
library(rgbif)

library(tidyverse)
occ = occ_data(scientificName = 'Puma concolor', 
                limit = 200000, 
                hasCoordinate = TRUE, 
                hasGeospatialIssue = FALSE)

occ_col <- filter(occ$data, country == 'ECUADOR')
shp <- raster::getData('GADM', country = 'ECUA', level = 1)

gg <- ggplot() +
  geom_point(data = occ_col, aes(x = decimalLongitude, y = decimalLatitude), color = 'black') +
  geom_polygon(data = shp, aes(x = long, y = lat, group = group), color = 'grey', fill = NA) +
  coord_fixed(ylim = c(-5, 12.5), xlim = c(-80, -67)) +
  xlab('Longitud') +
  ylab('Latitud')

ggsave(plot = gg, filename = 'Puma concolor.png', units = 'cm', width = 12, height = 16, dpi = 300)

gg

```


```{r}
require(pacman)
pacman::p_load(rnaturalearthdata, extrafont, showtext, rnaturalearth, cptcity, 
               SSDM, ggspatial, raster, terra, rgbif, tidyverse, sf, sp, 
               geodata, glue, ggpubr)

```

```{r}
g = gc(reset=T)
rm(list=ls())
options(scipen = 999, warn = -1)
```

```{r}
# load data 
sps = "Aedes aegypti"
occr = occ_data(scientificName = sps, limit = 10e5, hasCoordinate = T, 
                hasGeospatialIssue = F)

```

```{r}
# Selec datafrane from occr object and filter for a country
occr = occr[[2]]
unique(occr$country) %>%  sort()
occr = occr %>%  dplyr::filter(country == "Ecuador")
```



# Get shapefiles
wrld = ne_countries(returnclass = "sf", scale = 50)
ecu1 = geodata::gadm(country = "ECU", level = 1, path = "tmpr")

# Exploratory maps 
plot(st_geometry(wrld))
plot(ecu1)
points(occr$decimalLongitude, occr$decimalLatitude, pch = 16, col = "red")

# climatic data 
bioc = geodata::worldclim_country(country = "ECU", var = "bioc", path = "tmpr")
bioc = terra::crop(bioc, ecu1) %>% terra::mask(., ecu1)
names(bioc) = glue("bioc{1:19}")

# Merge coordinates and bioclimatic data
occr = occr %>%  dplyr::select(x = decimalLongitude, y = decimalLatitude)
vles = terra::extract(bioc, occr[,c("x", "y")])
occr = cbind(occr[,c("x", "y")], vles[,-1])
occr = as_tibble(occr)
occr = mutate(occr, pb = 1)

# Generate backgroun 
cell = terra::extract(bioc[[1]], occr[,1:2], cells=T)$cell
duplicated(cell)
mask = bioc[[1]]*0
mask[cell] = NA
back = terra::as.data.frame(mask, xy =T) %>% as_tibble()
back = sample_n(back, size = nrow(occr)*2, replace = FALSE)
colnames(back)[3] = "pb"
back = mutate(back, pb = 0)
back = cbind(back, terra::extract(bioc, back[,c(1,2)])[,-1])
back = as_tibble(back)

Se escogió la especie de mosquitos 